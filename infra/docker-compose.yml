services:
  postgres:
    image: postgres:13
    volumes:
      - dbstorage:/var/lib/postgresql/data
    expose: [5432]
    restart: always
    env_file:
      - .env
    profiles: ["all", "admin", "etl"]

  postgres-dev:
    extends: postgres
    ports: ["5432:5432"]
    env_file: [.env.dev]
    profiles: ["admin-dev"]


  admin:
    build:
      context: ./../admin
    depends_on:
      - postgres
    ports:
      - "8000:8000"
    environment:
      - DEBUG:True
    env_file:
      - .env
    profiles: ["all", "admin"]


  admin-nginx:
    build:
      context: ./../admin
      dockerfile: nginx/Dockerfile
    depends_on:
      - admin
    restart: always
    volumes:
      - ./../admin/nginx/configs/admin.conf:/etc/nginx/conf.d/configs/admin.conf
      - ./../admin/nginx/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
    profiles: ["all", "admin"]


  elasticsearch:
    image: elasticsearch:8.6.2
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    volumes:
      - esstorage:/usr/share/elasticsearch/data
    expose: [9200]
    restart: always
    profiles: ["all", "etl", "fastapi"]

  elasticsearch-clean:
    extends: elasticsearch
    volumes: !reset [] # must be created on fly
    profiles: ["fastapi-test"]


  etl:
    build:
      context: ./../etl
      dockerfile: Dockerfile
    environment:
      - .env
    depends_on:
      - postgres
      - elasticsearch
    restart: on-failure
    env_file:
      - .env
    profiles: ["all", "etl"]


  redis:
    image: redis
    restart: always
    expose: [6379]
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - redisstorage:/data
    profiles: ["all", "fastapi"]

  redis-clean:
    extends: redis
    volumes: !reset [] # must be created on the fly
    profiles: ["fastapi-test"]

  fastapi:
    build:
      context: ./../api
    ports: ["8001:26452"]
    depends_on: [elasticsearch, redis]
    env_file: [.env]
    profiles: ["all", "fastapi"]

  fastapi-test:
    build:
      context: ./../api
    env_file: [.env, .env.test]
    expose: [26452]
    depends_on: [elasticsearch-clean, redis-clean]
    profiles: ["fastapi-test"]

  fastapi-func-test:
    build:
      context: ./../api/tests/functional
    depends_on:
      - elasticsearch-clean
      - redis-clean
      - fastapi-test
    env_file: [.env, .env.test]
    entrypoint: >
      sh -c "ls && pwd && cd /opt
      && python3 -m functional.utils.wait_for_es
      && python3 -m functional.utils.wait_for_redis
      && pytest ./functional/tests"
    profiles: ["fastapi-test"]

  minio:
    image: minio/minio
    expose: [9000]
    env_file: [.env]
    volumes:
      - minio_storage:/data
    command: server --console-address ":9001" /data
    profiles: ["all", "admin"]

  minio-dev:
    extends: minio
    ports: ["9001:9001"]
    env_file: [.env.dev]
    profiles: ["admin-dev"]

  fileapi:
    build:
      context: ./../file_service
      dockerfile: Dockerfile
    expose: [8000]
    depends_on:
      - postgres
      - minio
    env_file: [.env]
    profiles: ["all", "admin"]

  fileapi-dev:
    extends: fileapi
    ports:
      - "8001:8000"
    depends_on: !reset ["postgres-dev", "minio-dev"]
    env_file: [.env.dev]
    profiles: ["admin-dev"]

  postgres-init:
    build:
      context: ./../postgres_init
      dockerfile: Dockerfile
    env_file: [.env]
    depends_on: [postgres]
    restart: "no"
    profiles: ["init"]

volumes:
  dbstorage:
    name: admin-panel-db
    external: true
  esstorage:
    name: admin-panel-es
    external: true
  redisstorage:
    name: admin-panel-redis
    external: true
  minio_storage:
    name: admin-panel-s3
    external: true


